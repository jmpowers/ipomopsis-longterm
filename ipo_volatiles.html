<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="John Powers" />

<meta name="date" content="2024-10-07" />

<title>Long-term Ipomopsis Floral Volatiles</title>

<script src="libs/header-attrs-2.26/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="libs/navigation-1.1/tabsets.js"></script>
<script src="libs/navigation-1.1/codefolding.js"></script>
<link href="libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>



<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Long-term <em>Ipomopsis</em> Floral
Volatiles</h1>
<h4 class="author"><a href="http://sites.uci.edu/powers/">John
Powers</a></h4>
<h4 class="date">2024-10-07</h4>

</div>


<style type="text/css">
.main-container { max-width: 1000px; margin-left: 0; margin-right: auto; }
img{ max-width:200%; height: auto; }
td, th { padding : 6px }
</style>
<pre class="r"><code>library(tidyverse)
library(pheatmap)
library(dendsort)
library(viridis)
library(RColorBrewer)
library(bouquet)
library(vegan)
library(ggvegan)
library(knitr)
knitr::opts_chunk$set(comment=&quot;&quot;, cache=T, warning = F, message = F, 
                      fig.path = &quot;images/&quot;, dev=&quot;svglite&quot;, dev.args=list(fix_text_size=FALSE), fig.height=8, fig.width=8)
options(digits=4, knitr.kable.NA = &quot;&quot;) # for kables
source(&quot;read_shimadzu.R&quot;)</code></pre>
<pre class="r"><code>metadata &lt;- list.files(&quot;data/volatiles&quot;, pattern = &quot;Ipomopsis long-term volatiles - 20&quot;, full.names=T) %&gt;% 
  map_dfr(~read_tsv(.x, show_col_types = F) %&gt;% 
            mutate(across(any_of(c(&quot;pump_id&quot;, &quot;plant&quot;, &quot;vial&quot;, &quot;sample&quot;)), as.character)), .id=&quot;metafile&quot;) %&gt;% 
  mutate(year = year(date))

# metadata %&gt;% add_count(year, date, time, site, type, sample) %&gt;% filter(n&gt;1) %&gt;% 
#   arrange(year, date, time, site, type, sample) %&gt;% write_tsv(&quot;data/volatiles/metadupes.tsv&quot;, na=&quot;&quot;)</code></pre>
<div id="field-metadata" class="section level1">
<h1>Field metadata</h1>
<pre class="r"><code>ggplot(metadata, aes(x=yday(date), fill=paste(site, time))) + 
  facet_wrap(vars(year), ncol=1) + geom_bar() +
  scale_fill_brewer(palette = &quot;Paired&quot;) + theme_classic() + 
  labs(x=&quot;Day of year&quot;, y=&quot;Samples&quot;, fill=&quot;Site, time&quot;)</code></pre>
<p><img src="images/plot_metadata-1.svg" width="768" /></p>
<pre class="r"><code>metadata %&gt;% filter(type==&quot;floral&quot;) %&gt;% count(year, site, time) %&gt;% 
  pivot_wider(names_from=c(&quot;site&quot;,&quot;time&quot;), values_from=&quot;n&quot;) %&gt;% kable(caption = &quot;floral samples&quot;)</code></pre>
<table>
<caption>floral samples</caption>
<thead>
<tr class="header">
<th align="right">year</th>
<th align="right">Ihyb_D</th>
<th align="right">Ihyb_N</th>
<th align="right">Lagg_D</th>
<th align="right">Lagg_N</th>
<th align="right">VF_D</th>
<th align="right">VF_N</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">2017</td>
<td align="right">34</td>
<td align="right">25</td>
<td align="right">50</td>
<td align="right">22</td>
<td align="right">53</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="right">2018</td>
<td align="right">8</td>
<td align="right">10</td>
<td align="right">15</td>
<td align="right"></td>
<td align="right">17</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="right">2019</td>
<td align="right">25</td>
<td align="right">29</td>
<td align="right">40</td>
<td align="right"></td>
<td align="right">17</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="right">2020</td>
<td align="right">20</td>
<td align="right">24</td>
<td align="right"></td>
<td align="right"></td>
<td align="right">14</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="right">2021</td>
<td align="right">15</td>
<td align="right">24</td>
<td align="right">44</td>
<td align="right">28</td>
<td align="right">20</td>
<td align="right">21</td>
</tr>
<tr class="even">
<td align="right">2022</td>
<td align="right">41</td>
<td align="right">82</td>
<td align="right">49</td>
<td align="right">47</td>
<td align="right">19</td>
<td align="right">20</td>
</tr>
<tr class="odd">
<td align="right">2023</td>
<td align="right">18</td>
<td align="right">19</td>
<td align="right">42</td>
<td align="right">40</td>
<td align="right">17</td>
<td align="right"></td>
</tr>
</tbody>
</table>
<pre class="r"><code>metadata %&gt;% filter(type==&quot;ambient&quot;) %&gt;% count(year, site, time) %&gt;% 
  pivot_wider(names_from=c(&quot;site&quot;,&quot;time&quot;), values_from=&quot;n&quot;) %&gt;% kable(caption = &quot;ambient samples&quot;)</code></pre>
<table>
<caption>ambient samples</caption>
<thead>
<tr class="header">
<th align="right">year</th>
<th align="right">Ihyb_D</th>
<th align="right">Ihyb_N</th>
<th align="right">Lagg_D</th>
<th align="right">Lagg_N</th>
<th align="right">VF_D</th>
<th align="right">VF_N</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">2017</td>
<td align="right">3</td>
<td align="right">1</td>
<td align="right">3</td>
<td align="right">1</td>
<td align="right">3</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">2018</td>
<td align="right">3</td>
<td align="right">2</td>
<td align="right">2</td>
<td align="right"></td>
<td align="right">2</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="right">2019</td>
<td align="right">5</td>
<td align="right">4</td>
<td align="right">3</td>
<td align="right"></td>
<td align="right">6</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="right">2020</td>
<td align="right">3</td>
<td align="right">3</td>
<td align="right"></td>
<td align="right"></td>
<td align="right">2</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="right">2021</td>
<td align="right">3</td>
<td align="right">3</td>
<td align="right">3</td>
<td align="right">7</td>
<td align="right">2</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="right">2022</td>
<td align="right">10</td>
<td align="right">6</td>
<td align="right">3</td>
<td align="right">5</td>
<td align="right">4</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="right">2023</td>
<td align="right">2</td>
<td align="right">3</td>
<td align="right">4</td>
<td align="right">4</td>
<td align="right">1</td>
<td align="right"></td>
</tr>
</tbody>
</table>
<pre class="r"><code>metadata %&gt;% filter(type==&quot;floral&quot;) %&gt;% count(year, site, time, plant) %&gt;% count(year, site, time) %&gt;% 
  pivot_wider(names_from=c(&quot;site&quot;,&quot;time&quot;), values_from=&quot;n&quot;) %&gt;% kable(caption = &quot;plants&quot;)</code></pre>
<table>
<caption>plants</caption>
<thead>
<tr class="header">
<th align="right">year</th>
<th align="right">Ihyb_D</th>
<th align="right">Ihyb_N</th>
<th align="right">Lagg_D</th>
<th align="right">Lagg_N</th>
<th align="right">VF_D</th>
<th align="right">VF_N</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">11</td>
<td align="right">11</td>
<td align="right">10</td>
<td align="right">44</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="right">2018</td>
<td align="right">8</td>
<td align="right">10</td>
<td align="right">15</td>
<td align="right"></td>
<td align="right">17</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="right">2019</td>
<td align="right">25</td>
<td align="right">29</td>
<td align="right">40</td>
<td align="right"></td>
<td align="right">16</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="right">2020</td>
<td align="right">20</td>
<td align="right">21</td>
<td align="right"></td>
<td align="right"></td>
<td align="right">13</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="right">2021</td>
<td align="right">15</td>
<td align="right">18</td>
<td align="right">41</td>
<td align="right">28</td>
<td align="right">20</td>
<td align="right">19</td>
</tr>
<tr class="even">
<td align="right">2022</td>
<td align="right">26</td>
<td align="right">31</td>
<td align="right">48</td>
<td align="right">46</td>
<td align="right">19</td>
<td align="right">20</td>
</tr>
<tr class="odd">
<td align="right">2023</td>
<td align="right">18</td>
<td align="right">19</td>
<td align="right">41</td>
<td align="right">40</td>
<td align="right">17</td>
<td align="right"></td>
</tr>
</tbody>
</table>
<pre class="r"><code>left_join(metadata %&gt;% filter(type==&quot;floral&quot;) %&gt;% count(year, site, time, name=&quot;samples&quot;),
          metadata %&gt;% filter(type==&quot;floral&quot;) %&gt;% count(year, site, time, plant) %&gt;% count(year, site, time, name=&quot;plants&quot;)) %&gt;% 
  mutate(samples_per_plant = samples/plants, .keep=&quot;unused&quot;) %&gt;% 
    pivot_wider(names_from=c(&quot;site&quot;,&quot;time&quot;), values_from=&quot;samples_per_plant&quot;) %&gt;% kable(caption = &quot;samples per plant&quot;)</code></pre>
<table>
<caption>samples per plant</caption>
<thead>
<tr class="header">
<th align="right">year</th>
<th align="right">Ihyb_D</th>
<th align="right">Ihyb_N</th>
<th align="right">Lagg_D</th>
<th align="right">Lagg_N</th>
<th align="right">VF_D</th>
<th align="right">VF_N</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">2017</td>
<td align="right">2.833</td>
<td align="right">2.273</td>
<td align="right">4.545</td>
<td align="right">2.200</td>
<td align="right">1.204</td>
<td align="right">1.000</td>
</tr>
<tr class="even">
<td align="right">2018</td>
<td align="right">1.000</td>
<td align="right">1.000</td>
<td align="right">1.000</td>
<td align="right"></td>
<td align="right">1.000</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="right">2019</td>
<td align="right">1.000</td>
<td align="right">1.000</td>
<td align="right">1.000</td>
<td align="right"></td>
<td align="right">1.062</td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="right">2020</td>
<td align="right">1.000</td>
<td align="right">1.143</td>
<td align="right"></td>
<td align="right"></td>
<td align="right">1.077</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="right">2021</td>
<td align="right">1.000</td>
<td align="right">1.333</td>
<td align="right">1.073</td>
<td align="right">1.000</td>
<td align="right">1.000</td>
<td align="right">1.105</td>
</tr>
<tr class="even">
<td align="right">2022</td>
<td align="right">1.577</td>
<td align="right">2.645</td>
<td align="right">1.021</td>
<td align="right">1.022</td>
<td align="right">1.000</td>
<td align="right">1.000</td>
</tr>
<tr class="odd">
<td align="right">2023</td>
<td align="right">1.000</td>
<td align="right">1.000</td>
<td align="right">1.024</td>
<td align="right">1.000</td>
<td align="right">1.000</td>
<td align="right"></td>
</tr>
</tbody>
</table>
<div id="soil-moisture" class="section level2">
<h2>Soil moisture</h2>
<pre class="r"><code>metadata %&gt;% filter(type==&quot;floral&quot;) %&gt;% group_by(year, site, time, date) %&gt;% summarize(has_VWC = mean(!is.na(VWC))) %&gt;% 
  ggplot(aes(y=fct_rev(paste(date, site, time)), color=paste(site, time), x=has_VWC)) + geom_point(size=3) +
  scale_color_brewer(palette = &quot;Paired&quot;) + theme_minimal() + 
  labs(x=&quot;Fraction of floral samples with soil moisture recorded&quot;, y=&quot;Date, site, time&quot;, color=&quot;Site, time&quot;)</code></pre>
<p><img src="images/soil_moisture-1.svg" width="768" /></p>
<pre class="r"><code>ggplot(metadata, aes(x=yday(date), color=paste(site, time), y=VWC)) + 
  facet_wrap(vars(year), ncol=1) + geom_point() +
  scale_color_brewer(palette = &quot;Paired&quot;) + theme_classic() + 
  labs(x=&quot;Day of year&quot;, y=&quot;Soil moisture&quot;, color=&quot;Site, time&quot;)</code></pre>
<p><img src="images/soil_moisture-2.svg" width="768" /></p>
<pre class="r"><code>ggplot(metadata, aes(x=site, fill=paste(site, time), y=VWC)) + 
  facet_wrap(vars(year), nrow=1) + geom_boxplot(outlier.size=0.5) +
  scale_fill_brewer(palette = &quot;Paired&quot;) + theme_classic() + 
  labs(x=&quot;Site&quot;, y=&quot;Soil moisture&quot;, fill=&quot;Site, time&quot;)</code></pre>
<p><img src="images/soil_moisture-3.svg" width="768" /></p>
</div>
<div id="extraction-time" class="section level2">
<h2>Extraction time</h2>
<pre class="r"><code>ggplot(metadata, aes(x=site, fill=paste(site, time), y=bag)) + 
  facet_grid(time~year, scales = &quot;free_y&quot;) + geom_boxplot(outlier.size=0.5) +
  scale_fill_brewer(palette = &quot;Paired&quot;) + theme_minimal() + 
  labs(x=&quot;Site&quot;, y=&quot;Bag time&quot;, fill=&quot;Site, time&quot;)</code></pre>
<p><img src="images/time-1.svg" width="768" /></p>
<pre class="r"><code>ggplot(metadata, aes(x=site, fill=paste(site, time), y=(pump-bag)/60)) + 
  facet_wrap(vars(year), nrow=1) + geom_boxplot(outlier.size=0.5) +
  scale_fill_brewer(palette = &quot;Paired&quot;) + theme_minimal() + 
  labs(x=&quot;Site&quot;, y=&quot;Equilibration time (min)&quot;, fill=&quot;Site, time&quot;)</code></pre>
<p><img src="images/time-2.svg" width="768" /></p>
<pre class="r"><code>ggplot(metadata, aes(x=site, fill=paste(site, time), y=(end-pump)/60)) + 
  facet_wrap(vars(year), nrow=1) + geom_boxplot(outlier.size=0.5) +
  scale_fill_brewer(palette = &quot;Paired&quot;) + theme_minimal() + 
  labs(x=&quot;Site&quot;, y=&quot;Pumping time (min)&quot;, fill=&quot;Site, time&quot;)</code></pre>
<p><img src="images/time-3.svg" width="768" /></p>
</div>
</div>
<div id="matching-field-metadata-and-filenames" class="section level1">
<h1>Matching field metadata and filenames</h1>
<pre class="r"><code>filemeta &lt;- read_csv(&quot;data/volatiles/Ipomopsis GCMS files - ipo_meta_split.csv&quot;) %&gt;% 
  filter(type != &quot;blank&quot;, #GC blank
         !verdict %in% c(&quot;skip-notrun&quot;, #tube was skipped by the autosampler
                         &quot;leak-blank&quot;, #tube leaked, not desorbed but GC run anyway
                         &quot;mismatch-leak&quot;, #tube leaked, tube time not aligned with file time
                         &quot;skip-rename-mismatch-leak&quot;, #tube leaked after skip, tube time not aligned with file time
                         &quot;filemoved&quot; #file was moved on disk so creation time is wrong
         )) %&gt;% drop_na(type, FileName) %&gt;%  #no file match to desorb start time
  distinct(FileName, .keep_all = T) %&gt;% #some files got duplicated from fuzzy matching times
  mutate(date = ymd(date), year=year(date), vial=as.character(vial))

#TODO figure out which of these dupes has the real sample
filemeta %&gt;% add_count(year, date, time, site, type, sample) %&gt;% filter(n&gt;1) %&gt;% 
  arrange(year, date, time, site, type, sample) %&gt;% write_tsv(&quot;data/volatiles/filedupes.tsv&quot;, na=&quot;&quot;)
#until then, use only the first duplicate
filemeta &lt;- filemeta %&gt;% distinct(year, date, time, site, type, sample, .keep_all=T)

bind_rows(files=filemeta, field=metadata, .id=&quot;source&quot;)%&gt;%  
  ggplot(aes(y=paste(date, site, time), fill=source)) + 
  geom_bar(position=position_dodge(width=0.4)) + 
  scale_fill_brewer(palette = &quot;Set2&quot;) + theme_classic() + 
  labs(y=&quot;Date, site, time&quot;, x=&quot;Samples&quot;, fill=&quot;Source&quot;)</code></pre>
<p><img src="images/plot_matching-1.svg" width="768" /></p>
<pre class="r"><code>full_join(count(filemeta, type, name=&quot;files&quot;), count(metadata, type, name=&quot;field&quot;)) %&gt;% kable()</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">type</th>
<th align="right">files</th>
<th align="right">field</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">ambient</td>
<td align="right">107</td>
<td align="right">113</td>
</tr>
<tr class="even">
<td align="left">floral</td>
<td align="right">929</td>
<td align="right">952</td>
</tr>
<tr class="odd">
<td align="left">leaf</td>
<td align="right">16</td>
<td align="right">16</td>
</tr>
</tbody>
</table>
<pre class="r"><code>full_join(count(filemeta, year, date, time, site, name=&quot;files&quot;), 
          count(metadata, year, date, time, site, name=&quot;field&quot;)) %&gt;% kable()</code></pre>
<table>
<thead>
<tr class="header">
<th align="right">year</th>
<th align="left">date</th>
<th align="left">time</th>
<th align="left">site</th>
<th align="right">files</th>
<th align="right">field</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">2017</td>
<td align="left">2017-07-10</td>
<td align="left">D</td>
<td align="left">VF</td>
<td align="right">22</td>
<td align="right">11</td>
</tr>
<tr class="even">
<td align="right">2017</td>
<td align="left">2017-07-13</td>
<td align="left">D</td>
<td align="left">VF</td>
<td align="right">29</td>
<td align="right">29</td>
</tr>
<tr class="odd">
<td align="right">2017</td>
<td align="left">2017-07-14</td>
<td align="left">D</td>
<td align="left">VF</td>
<td align="right">19</td>
<td align="right">19</td>
</tr>
<tr class="even">
<td align="right">2017</td>
<td align="left">2017-07-18</td>
<td align="left">D</td>
<td align="left">Lagg</td>
<td align="right">22</td>
<td align="right">23</td>
</tr>
<tr class="odd">
<td align="right">2017</td>
<td align="left">2017-07-20</td>
<td align="left">D</td>
<td align="left">Lagg</td>
<td align="right">19</td>
<td align="right">19</td>
</tr>
<tr class="even">
<td align="right">2017</td>
<td align="left">2017-07-21</td>
<td align="left">D</td>
<td align="left">Ihyb</td>
<td align="right">3</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="right">2017</td>
<td align="left">2017-07-21</td>
<td align="left">D</td>
<td align="left">Lagg</td>
<td align="right">14</td>
<td align="right">14</td>
</tr>
<tr class="even">
<td align="right">2017</td>
<td align="left">2017-07-24</td>
<td align="left">D</td>
<td align="left">Ihyb</td>
<td align="right">30</td>
<td align="right">31</td>
</tr>
<tr class="odd">
<td align="right">2017</td>
<td align="left">2017-07-27</td>
<td align="left">D</td>
<td align="left">Ihyb</td>
<td align="right">6</td>
<td align="right">6</td>
</tr>
<tr class="even">
<td align="right">2017</td>
<td align="left">2017-07-31</td>
<td align="left">N</td>
<td align="left">VF</td>
<td align="right">5</td>
<td align="right">5</td>
</tr>
<tr class="odd">
<td align="right">2017</td>
<td align="left">2017-08-01</td>
<td align="left">N</td>
<td align="left">Ihyb</td>
<td align="right">25</td>
<td align="right">25</td>
</tr>
<tr class="even">
<td align="right">2017</td>
<td align="left">2017-08-10</td>
<td align="left">N</td>
<td align="left">Ihyb</td>
<td align="right">2</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="right">2017</td>
<td align="left">2017-08-10</td>
<td align="left">N</td>
<td align="left">Lagg</td>
<td align="right">24</td>
<td align="right">24</td>
</tr>
<tr class="even">
<td align="right">2018</td>
<td align="left">2018-07-18</td>
<td align="left">D</td>
<td align="left">VF</td>
<td align="right">20</td>
<td align="right">20</td>
</tr>
<tr class="odd">
<td align="right">2018</td>
<td align="left">2018-07-19</td>
<td align="left">D</td>
<td align="left">Lagg</td>
<td align="right">18</td>
<td align="right">18</td>
</tr>
<tr class="even">
<td align="right">2018</td>
<td align="left">2018-07-19</td>
<td align="left">N</td>
<td align="left">Ihyb</td>
<td align="right">13</td>
<td align="right">13</td>
</tr>
<tr class="odd">
<td align="right">2018</td>
<td align="left">2018-07-20</td>
<td align="left">D</td>
<td align="left">Ihyb</td>
<td align="right">8</td>
<td align="right">8</td>
</tr>
<tr class="even">
<td align="right">2018</td>
<td align="left">2018-07-26</td>
<td align="left">D</td>
<td align="left">Ihyb</td>
<td align="right">4</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="right">2019</td>
<td align="left">2019-07-23</td>
<td align="left">D</td>
<td align="left">VF</td>
<td align="right">23</td>
<td align="right">23</td>
</tr>
<tr class="even">
<td align="right">2019</td>
<td align="left">2019-07-30</td>
<td align="left">D</td>
<td align="left">Lagg</td>
<td align="right">43</td>
<td align="right">43</td>
</tr>
<tr class="odd">
<td align="right">2019</td>
<td align="left">2019-08-02</td>
<td align="left">D</td>
<td align="left">Ihyb</td>
<td align="right">29</td>
<td align="right">30</td>
</tr>
<tr class="even">
<td align="right">2019</td>
<td align="left">2019-08-12</td>
<td align="left">N</td>
<td align="left">Ihyb</td>
<td align="right">32</td>
<td align="right">33</td>
</tr>
<tr class="odd">
<td align="right">2020</td>
<td align="left">2020-07-15</td>
<td align="left">N</td>
<td align="left">Ihyb</td>
<td align="right">23</td>
<td align="right">27</td>
</tr>
<tr class="even">
<td align="right">2020</td>
<td align="left">2020-07-17</td>
<td align="left">D</td>
<td align="left">VF</td>
<td align="right">14</td>
<td align="right">16</td>
</tr>
<tr class="odd">
<td align="right">2020</td>
<td align="left">2020-07-21</td>
<td align="left">D</td>
<td align="left">Ihyb</td>
<td align="right">20</td>
<td align="right">23</td>
</tr>
<tr class="even">
<td align="right">2021</td>
<td align="left">2021-07-12</td>
<td align="left">N</td>
<td align="left">Ihyb</td>
<td align="right">27</td>
<td align="right">27</td>
</tr>
<tr class="odd">
<td align="right">2021</td>
<td align="left">2021-07-15</td>
<td align="left">D</td>
<td align="left">Lagg</td>
<td align="right">46</td>
<td align="right">47</td>
</tr>
<tr class="even">
<td align="right">2021</td>
<td align="left">2021-07-20</td>
<td align="left">D</td>
<td align="left">VF</td>
<td align="right">6</td>
<td align="right">22</td>
</tr>
<tr class="odd">
<td align="right">2021</td>
<td align="left">2021-07-21</td>
<td align="left">D</td>
<td align="left">Ihyb</td>
<td align="right">20</td>
<td align="right">18</td>
</tr>
<tr class="even">
<td align="right">2021</td>
<td align="left">2021-08-04</td>
<td align="left">N</td>
<td align="left">VF</td>
<td align="right">23</td>
<td align="right">23</td>
</tr>
<tr class="odd">
<td align="right">2021</td>
<td align="left">2021-08-05</td>
<td align="left">N</td>
<td align="left">Lagg</td>
<td align="right">35</td>
<td align="right">35</td>
</tr>
<tr class="even">
<td align="right">2022</td>
<td align="left">2022-07-11</td>
<td align="left">N</td>
<td align="left">Ihyb</td>
<td align="right">36</td>
<td align="right">34</td>
</tr>
<tr class="odd">
<td align="right">2022</td>
<td align="left">2022-07-12</td>
<td align="left">D</td>
<td align="left">Ihyb</td>
<td align="right">29</td>
<td align="right">32</td>
</tr>
<tr class="even">
<td align="right">2022</td>
<td align="left">2022-07-21</td>
<td align="left">D</td>
<td align="left">Lagg</td>
<td align="right">51</td>
<td align="right">52</td>
</tr>
<tr class="odd">
<td align="right">2022</td>
<td align="left">2022-07-21</td>
<td align="left">N</td>
<td align="left">Lagg</td>
<td align="right">51</td>
<td align="right">52</td>
</tr>
<tr class="even">
<td align="right">2022</td>
<td align="left">2022-07-27</td>
<td align="left">N</td>
<td align="left">Ihyb</td>
<td align="right">54</td>
<td align="right">54</td>
</tr>
<tr class="odd">
<td align="right">2022</td>
<td align="left">2022-07-28</td>
<td align="left">D</td>
<td align="left">Ihyb</td>
<td align="right">11</td>
<td align="right">19</td>
</tr>
<tr class="even">
<td align="right">2022</td>
<td align="left">2022-08-01</td>
<td align="left">D</td>
<td align="left">VF</td>
<td align="right">21</td>
<td align="right">23</td>
</tr>
<tr class="odd">
<td align="right">2022</td>
<td align="left">2022-08-02</td>
<td align="left">N</td>
<td align="left">VF</td>
<td align="right">24</td>
<td align="right">24</td>
</tr>
<tr class="even">
<td align="right">2023</td>
<td align="left">2023-07-20</td>
<td align="left">D</td>
<td align="left">Lagg</td>
<td align="right">49</td>
<td align="right">46</td>
</tr>
<tr class="odd">
<td align="right">2023</td>
<td align="left">2023-07-20</td>
<td align="left">N</td>
<td align="left">Lagg</td>
<td align="right">44</td>
<td align="right">44</td>
</tr>
<tr class="even">
<td align="right">2023</td>
<td align="left">2023-07-21</td>
<td align="left">D</td>
<td align="left">VF</td>
<td align="right">17</td>
<td align="right">18</td>
</tr>
<tr class="odd">
<td align="right">2023</td>
<td align="left">2023-07-27</td>
<td align="left">D</td>
<td align="left">Ihyb</td>
<td align="right">20</td>
<td align="right">20</td>
</tr>
<tr class="even">
<td align="right">2023</td>
<td align="left">2023-07-27</td>
<td align="left">N</td>
<td align="left">Ihyb</td>
<td align="right">21</td>
<td align="right">22</td>
</tr>
</tbody>
</table>
<pre class="r"><code>#library(tidylog)
meta.full &lt;- full_join(mutate(filemeta, files=1), 
                  mutate(metadata, field=1), by=c(&quot;year&quot;, &quot;date&quot;, &quot;time&quot;, &quot;site&quot;, &quot;type&quot;, &quot;sample&quot;)) %&gt;% 
  mutate(files=replace_na(files, 0), field=replace_na(field, 0), match = files==1 &amp; field==1)

meta.full %&gt;% filter(match==F) %&gt;% arrange(date, time, site, field, files) %&gt;% 
  select(date, time, site, type, field, files, sample, 
         rundate, samplename, vial.x, vial.y, split_notes, notes) %&gt;% 
  write_tsv(&quot;data/volatiles/matching.tsv&quot;, na=&quot;&quot;)

meta.full %&gt;% group_by(year, date, time, site) %&gt;% 
  summarize(across(c(files, field, match), mean)) %&gt;% 
  mutate(files=files-match, field=field-match) %&gt;% 
  pivot_longer(c(files, field, match)) %&gt;% 
  mutate(name=factor(name, levels=c(&quot;files&quot;, &quot;match&quot;, &quot;field&quot;))) %&gt;% 
  ggplot(aes(y=paste(date, site, time), x=value, fill=name)) + geom_col() +
  labs(x=&quot;&quot;,y=&quot;&quot;, fill=&quot;&quot;) + theme_minimal()</code></pre>
<p><img src="images/matching-1.svg" width="768" /></p>
</div>
<div id="filtering-compounds" class="section level1">
<h1>Filtering compounds</h1>
<pre class="r"><code># load short names 
ipochems &lt;- read_csv(&quot;data/volatiles/Ipo volatile compounds - chemsf_ipo.csv&quot;) %&gt;% 
  select(name, shortname, standard, verdict) %&gt;%  filter(verdict != &quot;&quot;) %&gt;% 
  mutate(standard = fct_recode(standard, &quot;Methyl_salicylate&quot;=&quot;Benzaldehyde&quot;), # benzaldehyde regressions not reliable
         class = fct_recode(standard, Aliphatics=&quot;Hexenol&quot;, Benzenoids=&quot;Methyl_salicylate&quot;, Benzenoids=&quot;Indole&quot;, 
                            Sesquiterpenes=&quot;Caryophyllene&quot;, Monoterpenes=&quot;alpha_Pinene&quot;, Monoterpenes=&quot;Linalool&quot;)) %&gt;%  
  left_join(read_csv(&quot;data/volatiles/regressions_181921_filtered_slopes.csv&quot;) %&gt;% 
              pivot_wider(id_cols=standard, names_from=&quot;year&quot;, names_prefix=&quot;area_per_ng&quot;, values_from=area_per_ng)) 
class_pal &lt;- set_names(c(&quot;#BC0060&quot;,&quot;#027B8C&quot;,&quot;#E56E00&quot;,&quot;#86D400&quot;), levels(ipochems$class))

#shorten chemical names and merge compounds with multiple names
shortnames &lt;- ipochems %&gt;% select(name, shortname) %&gt;% filter(shortname!=&quot;&quot;) %&gt;% deframe()
#shortnames[shortnames %in% shortnames[duplicated(shortnames)]]

greekify &lt;- function(names) {
  names %&gt;% 
    str_replace(&quot;^a-&quot;,&quot;\U03B1-&quot;) %&gt;% str_replace(&quot;-a-&quot;,&quot;-\U03B1-&quot;) %&gt;% 
    str_replace(&quot;^b-&quot;,&quot;\U03B2-&quot;) %&gt;% str_replace(&quot;-b-&quot;,&quot;-\U03B2-&quot;) %&gt;% 
    str_replace(&quot;^g-&quot;,&quot;\U03B3-&quot;) %&gt;% str_replace(&quot;-g-&quot;,&quot;-\U03B3-&quot;)
}</code></pre>
<pre class="r"><code>quant.full &lt;- list.files(&quot;data/volatiles/quant/&quot;, full.names = T) %&gt;% 
  map_dfr(read.shimadzu.quant) %&gt;%
  mutate(Name = trimws(Name), Area=replace_na(Area, 0)) %&gt;% 
  distinct(Filename, Name, .keep_all=T)

setdiff(quant.full$Filename, meta.full$FileName)#TODO no metadata, consider filling some in</code></pre>
<pre><code> [1] &quot;Blank1_852019_01.qgd&quot;                 
 [2] &quot;I23DAug2_08052019.qgd&quot;                
 [3] &quot;L13NAug10_09022017.qgd&quot;               
 [4] &quot;VF9D07142017_07140217anal.qgd&quot;        
 [5] &quot;Ihyb_20_210712_redo_8252021_07.qgd&quot;   
 [6] &quot;Lagg_26_210715_8222021_07.qgd&quot;        
 [7] &quot;No_Drierite_2_07152021_7162021_14.qgd&quot;
 [8] &quot;5_Ihyb_nodate_7142021_20.qgd&quot;         
 [9] &quot;Ihyb_222_230728_8232023_10.qgd&quot;       
[10] &quot;Ihyb_223_230728_8222023_25.qgd&quot;       
[11] &quot;Ihyb_232_230728_8232023_12.qgd&quot;       
[12] &quot;Ihyb_235_230728_8232023_06.qgd&quot;       
[13] &quot;Ihyb_403_230728_8222023_06.qgd&quot;       
[14] &quot;PGVF_5_8312023_07.qgd&quot;                
[15] &quot;PGVF_80_8302023_15.qgd&quot;               
[16] &quot;PGVF_121_8292023_28.qgd&quot;              
[17] &quot;Ihyb_703B_N_220727_812022_15.qgd&quot;     
[18] &quot;Ihyb_707B_N_220727_812022_13.qgd&quot;     
[19] &quot;Ihyb_721B_N_220727_812022_10.qgd&quot;     
[20] &quot;Ihyb_732_D_220712_822022_13.qgd&quot;      
[21] &quot;Ihyb_AIRJP_D_220712_842022_14.qgd&quot;    
[22] &quot;Ihyb_T1_N_220727_822022_01.qgd&quot;       
[23] &quot;Ihyb_T2_N_220727_822022_02.qgd&quot;       
[24] &quot;Ihyb_T3_N_220727_822022_03.qgd&quot;       
[25] &quot;Ihyb_T4_N_220727_822022_04.qgd&quot;       
[26] &quot;Ihyb_T5_N_220727_822022_05.qgd&quot;       
[27] &quot;Ihyb_T6_N_220727_822022_06.qgd&quot;       
[28] &quot;Ihyb_T7_N_220727_822022_07.qgd&quot;       
[29] &quot;Lagg_415_N_220721_7282022_25.qgd&quot;     
[30] &quot;Lagg_548_D_220721_7282022_13.qgd&quot;     
[31] &quot;Lagg_AIRDH_N_220721_7262022_24.qgd&quot;   
[32] &quot;VF_978_N_220802_852022_08.qgd&quot;        
[33] &quot;VF_AIRJK_D_220801_852022_03.qgd&quot;      
[34] &quot;VF_AIRJP_D_220801_842022_19.qgd&quot;      </code></pre>
<pre class="r"><code>#only keep file-metadata matches
files.match &lt;- intersect(meta.full$FileName, quant.full$Filename)
meta.all   &lt;- meta.full %&gt;% filter(FileName %in% files.match)
quant.all &lt;- quant.full %&gt;% filter(Filename %in% files.match) %&gt;%
  select(Filename, Name, Area) %&gt;%
  mutate(Name = recode(Name, !!!shortnames)) %&gt;%
  pivot_wider(names_from = &quot;Name&quot;, values_from=&quot;Area&quot;) %&gt;% 
  arrange(match(Filename, meta.all$FileName)) %&gt;% 
  write_tsv(&quot;data/volatiles/quant_all.tsv&quot;) %&gt;% 
  as.data.frame() %&gt;% column_to_rownames(&quot;Filename&quot;)</code></pre>
<pre class="r"><code>qual.full &lt;- list.files(&quot;data/volatiles/qual/&quot;, full.names = T) %&gt;% 
  map_dfr(read.shimadzu)

#only keep file-metadata matches
files.match &lt;- intersect(meta.full$FileName, qual.full$Filename)
meta.all   &lt;- meta.full %&gt;% filter(FileName %in% files.match)
qual.data &lt;-  qual.full %&gt;% filter(Filename %in% files.match) %&gt;% 
  filter(Name != &quot;&quot;) %&gt;% #drop peaks without identifications
  mutate(Name = droplevels(recode(Name, !!!shortnames)))#bouquet doesn&#39;t like empty levels
qual.all &lt;- qual.data %&gt;% select(Filename, Name, Area) %&gt;%
  pivot_wider(names_from = &quot;Name&quot;, values_from=&quot;Area&quot;, values_fn = sum) %&gt;% 
  arrange(match(Filename, meta.all$FileName)) %&gt;% 
  as.data.frame() %&gt;% column_to_rownames(&quot;Filename&quot;)</code></pre>
<pre class="r"><code>longdata &lt;- qual.data %&gt;% load_longdata(sample=&quot;Filename&quot;, RT=&quot;Ret.Time&quot;, 
                          name=&quot;Name&quot;, area=&quot;Area&quot;, match = &quot;SI&quot;, maxmatch=100) 
metadata.df &lt;- meta.all %&gt;% 
  as.data.frame() %&gt;% #tibbles break bouquet&#39;s add_count_freqs
  select(-sample) %&gt;% #name conflict with bouquet
  load_metadata(date=&quot;date&quot;, sample=&quot;FileName&quot;, type=&quot;type&quot;)
rownames(metadata.df) &lt;- metadata.df$sample

qual.all &lt;- make_sampletable(longdata, metadata.df)
chems &lt;- make_chemtable(longdata, metadata.df)</code></pre>
<div id="bouquet" class="section level2">
<h2>Bouquet</h2>
<pre class="r"><code>chemsf &lt;- chems %&gt;%
  filter_RT(2, 17) %&gt;% 
  filter_match(0.8) %&gt;% 
  filter_freq(0.1) %&gt;% 
  filter_contaminant(cont.list = c(&quot;Caprolactam&quot;)) %&gt;%
  filter_area(min_maximum = 1e5) %&gt;% 
  filter_ambient_ratio(qual.all, metadata.df, ratio = 4) %&gt;%
  combine_filters() 

chemsf$filter_final &lt;- with(chemsf, filter_freq.floral==&quot;OK&quot; &amp;
                              filter_ambient_ratio==&quot;OK&quot;) #only use these for final filtering

bouquet::plot_filters(chemsf, option=&quot;rarity&quot;, yrange=3.5)</code></pre>
<p><img src="images/bouquet-1.svg" width="768" /></p>
<pre class="r"><code>bouquet::plot_filters(chemsf, option=&quot;ambient&quot;, yrange=3.5)</code></pre>
<p><img src="images/bouquet-2.svg" width="768" /></p>
<pre class="r"><code>bouquet::plot_filters(chemsf, option=&quot;prop&quot;)</code></pre>
<p><img src="images/bouquet-3.svg" width="768" /></p>
</div>
<div id="compare-quant-and-bouquet-compounds" class="section level2">
<h2>Compare quant and bouquet compounds</h2>
<pre class="r"><code>qual_chems &lt;- chemsf$name[chemsf$filter_final]

#TODO check on new compounds to investigate
(qual_only &lt;- setdiff(qual_chems, names(quant.all)))</code></pre>
<pre><code>[1] &quot;(3E,5E)-2,6-dimethylocta-3,5,7-trien-2-ol&quot;
[2] &quot;hex-2-enal&quot;                               
[3] &quot;5-Methyloxazolidine&quot;                      
[4] &quot;7-epi-trans-sesquisabinene hydrate&quot;       
[5] &quot;8-Hexadecenal, 14-methyl-, (Z)-&quot;          
[6] &quot;methyl 2-methylbutanoate&quot;                 
[7] &quot;carveol&quot;                                  
[8] &quot;Decane, 3,6-dimethyl-&quot;                    
[9] &quot;Formic acid, undecyl ester&quot;               </code></pre>
<pre class="r"><code>#chemsf %&gt;% filter(filter_final) %&gt;% mutate(check = name %in% qual_only, .before=1) %&gt;% View()

#TODO see if any other quant peak should be included
(quant_only &lt;- setdiff(names(quant.all), qual_chems))</code></pre>
<pre><code> [1] &quot;3-methylbutanal oxime&quot;                             
 [2] &quot;g-terpinene&quot;                                       
 [3] &quot;methyl benzoate&quot;                                   
 [4] &quot;(3E)-4,8-dimethylnona-1,3,7-triene&quot;                
 [5] &quot;2-methylbenzonitrile&quot;                              
 [6] &quot;a-campholenal&quot;                                     
 [7] &quot;Decanal&quot;                                           
 [8] &quot;Caprolactam&quot;                                       
 [9] &quot;Nonanoic acid&quot;                                     
[10] &quot;indole&quot;                                            
[11] &quot;(E)-a-bergamotene&quot;                                 
[12] &quot;pseudoionone&quot;                                      
[13] &quot;trans-Geranylgeraniol&quot;                             
[14] &quot;[(E)-hex-3-enyl] acetate&quot;                          
[15] &quot;[(E)-hex-3-enyl] butanoate&quot;                        
[16] &quot;(Z)-a-bergamotene&quot;                                 
[17] &quot;a-humulene&quot;                                        
[18] &quot;(2E)-2,7-dimethylocta-2,6-dien-1-ol&quot;               
[19] &quot;benzaldehyde&quot;                                      
[20] &quot;limonene&quot;                                          
[21] &quot;methyl salicylate&quot;                                 
[22] &quot;1,6,10-Dodecatrien-3-ol, 3,7,11-trimethyl-&quot;        
[23] &quot;(E)-4-oxohex-2-enal&quot;                               
[24] &quot;p-mentha-1,3,8-triene&quot;                             
[25] &quot;tricyclo[5.2.1.02,6]dec-2-ene&quot;                     
[26] &quot;3,6-diethyl-3,6-dimethyltricyclo[3.1.0.02,4]hexane&quot;
[27] &quot;furan-3-carbaldehyde&quot;                              
[28] &quot;sabinene&quot;                                          
[29] &quot;3-carene&quot;                                          
[30] &quot;b-caryophyllene oxide&quot;                             
[31] &quot;[(Z)-hex-3-enyl] 2-methylbutanoate&quot;                
[32] &quot;2-butyloctan-1-ol&quot;                                 
[33] &quot;hexan-1-ol&quot;                                        
[34] &quot;3-methylbutan-1-ol&quot;                                
[35] &quot;decan-2-one&quot;                                       
[36] &quot;1,2,3-Propanetriol, 1-acetate&quot;                     
[37] &quot;Benzamide&quot;                                         
[38] &quot;Benzenebutanoic acid, .gamma.-oxo-&quot;                </code></pre>
<pre class="r"><code>#chemsf %&gt;% filter(filter_final) %&gt;% mutate(check = name %in% iponew, .before=1) %&gt;% View()

# compounds in both quant and qual lists
(quant_qual &lt;- intersect(names(quant.all), qual_chems))</code></pre>
<pre><code> [1] &quot;(E)-hex-2-enal&quot;                           
 [2] &quot;a-pinene&quot;                                 
 [3] &quot;b-myrcene&quot;                                
 [4] &quot;(Z)-b-ocimene&quot;                            
 [5] &quot;(E)-b-ocimene&quot;                            
 [6] &quot;linalool&quot;                                 
 [7] &quot;a-copaene&quot;                                
 [8] &quot;petasitene&quot;                               
 [9] &quot;b-caryophyllene&quot;                          
[10] &quot;(E)-b-bergamotene&quot;                        
[11] &quot;a-farnesene&quot;                              
[12] &quot;(Z)-hex-3-en-1-ol&quot;                        
[13] &quot;[(Z)-hex-3-enyl] butanoate&quot;               
[14] &quot;a-terpineol&quot;                              
[15] &quot;cosmene&quot;                                  
[16] &quot;(4E,6Z)-alloocimene&quot;                      
[17] &quot;verbenone&quot;                                
[18] &quot;3-ethenyl-1,2-dimethylcyclohexa-1,4-diene&quot;
[19] &quot;geranial&quot;                                 </code></pre>
<pre class="r"><code>toolow &lt;- rownames(quant.all)[rowSums(quant.all[,quant_qual]) &lt; 2500] #exclude 2 samples with very low integrations

qual &lt;- prune_sampletable(qual.all, chemsf, metadata.df)[, quant_qual]
qual &lt;- qual[!rownames(qual) %in% toolow,]
quant &lt;- quant.all[rownames(qual), quant_qual]
meta &lt;- metadata.df[rownames(qual),] %&gt;% 
  mutate(across(c(year, site, time), factor))

quant %&gt;% rownames_to_column(&quot;FileName&quot;) %&gt;% write_tsv(&quot;data/volatiles/filtered_quant.tsv&quot;)
meta %&gt;% write_tsv(&quot;data/volatiles/filtered_meta.tsv&quot;)
save(quant, meta, file = &quot;data/volatiles/filtered_quantmeta.rda&quot;)</code></pre>
</div>
<div id="retention-time-of-qual-integrations" class="section level2">
<h2>Retention time of qual integrations</h2>
<pre class="r"><code>ggplot(longdata %&gt;% filter(name %in% qual_chems), 
       aes(x=RT, y=fct_reorder(name, RT), color=factor(name, levels=sample(levels(name))))) + 
  geom_jitter(width = 0, height=0.5) + guides(color=&quot;none&quot;) + ylab(&quot;&quot;)</code></pre>
<p><img src="images/retention-1.svg" width="768" /></p>
<pre class="r"><code>#TODO make sure quant has correct RT, investigate second peaks
#TODO cosmene/carveol/alloocimene puzzle
#TODO (E)-hex-2-enal vs. no isomer specified</code></pre>
</div>
</div>
<div id="ordinations-of-filtered-volatiles" class="section level1">
<h1>Ordinations of filtered volatiles</h1>
<div id="heatmap" class="section level2">
<h2>Heatmap</h2>
<pre class="r"><code>load(&quot;data/volatiles/filtered_quantmeta.rda&quot;)

pal &lt;- with(meta, list(
  year = set_names(brewer.pal(nlevels(year), &quot;Set2&quot;), levels(year)),
  site = set_names(brewer.pal(nlevels(site), &quot;Set1&quot;), levels(site)),
  time = set_names(c(&quot;lightblue&quot;,&quot;plum1&quot;), levels(time))))
times &lt;- c(D=&quot;day&quot;, N=&quot;night&quot;)

pheatmap(as.matrix(t(quant))^(1/4), 
         cluster_cols=T, show_colnames=F,
         clustering_method=&quot;mcquitty&quot;, clustering_distance_rows=&quot;correlation&quot;,
         clustering_callback = function(hc, ...){dendsort(hc, type=&quot;average&quot;)},
         annotation_col = meta %&gt;% select(year, site, time) %&gt;% mutate(across(everything(), factor)),
         annotation_colors =pal,
         scale=&quot;none&quot;, color=mako(512),main=&quot;Filtered quant volatiles&quot;)</code></pre>
<p><img src="images/quant_heatmap-1.png" width="960" /></p>
</div>
<div id="nmds" class="section level2">
<h2>NMDS</h2>
<pre class="r"><code>nmds &lt;- metaMDS(decostand(quant, &quot;hellinger&quot;), autotransform = F, trymax=1)</code></pre>
<pre><code>Run 0 stress 0.2002 
Run 1 stress 0.2293 
*** Best solution was not repeated -- monoMDS stopping criteria:
     1: scale factor of the gradient &lt; sfgrmin</code></pre>
<pre class="r"><code>nmds.df &lt;- fortify(nmds) %&gt;% left_join(mutate(meta, score=&quot;sites&quot;), by=c(label=&quot;sample&quot;, &quot;score&quot;))
nmds.plot &lt;- ggplot(filter(nmds.df, score==&quot;sites&quot;), aes(x=NMDS1, y=NMDS2, label=label)) +
  theme_classic() + theme(legend.position = &quot;top&quot;)

nmds.plot + geom_point(aes(color=time)) +
  geom_text(data=filter(nmds.df, score==&quot;species&quot;)) +
  scale_color_manual(&quot;Time&quot;, values=pal$time, label=times)</code></pre>
<p><img src="images/quant_nmds-1.svg" width="768" /></p>
<pre class="r"><code>nmds.plot + geom_point(aes(color=site, shape=time)) +
  scale_color_manual(&quot;Site&quot;, values=pal$site) + 
  scale_shape_manual(&quot;Time&quot;, values=c(1,19))</code></pre>
<p><img src="images/quant_nmds-2.svg" width="768" /></p>
<pre class="r"><code>nmds.plot + geom_point(aes(color=year, shape=time)) +
  geom_text(data=filter(nmds.df, score==&quot;species&quot;)) +
  scale_color_manual(&quot;Year&quot;, values=pal$year) + 
  scale_shape_manual(&quot;Time&quot;, values=c(1,19))</code></pre>
<p><img src="images/quant_nmds-3.svg" width="768" /></p>
</div>
<div id="cap-with-time-year-site" class="section level2">
<h2>CAP with time, year, site</h2>
<pre class="r"><code>cap.tys &lt;- capscale(sqrt(quant) ~ time + year + site + year:site + time:site, data=meta)
cap.tys</code></pre>
<pre><code>Call: capscale(formula = sqrt(quant) ~ time + year + site + year:site +
time:site, data = meta)

-- Model Summary --

               Inertia Proportion Rank
Total         1.13e+06   1.00e+00     
Constrained   4.91e+05   4.33e-01   19
Unconstrained 6.41e+05   5.67e-01   19

Inertia is mean squared Euclidean distance

-- Note --

Species scores projected from &#39;sqrt&#39;
Species scores projected from &#39;quant&#39;

Some constraints or conditions were aliased because they were redundant.
This can happen if terms are linearly dependent (collinear):
&#39;year2020:siteLagg&#39;

-- Eigenvalues --

Eigenvalues for constrained axes:
  CAP1   CAP2   CAP3   CAP4   CAP5   CAP6   CAP7   CAP8   CAP9  CAP10  CAP11 
415174  52561   7443   5603   4293   2089   1264    880    445    368    155 
 CAP12  CAP13  CAP14  CAP15  CAP16  CAP17  CAP18  CAP19 
   127     76     41     36     14      7      6      1 

Eigenvalues for unconstrained axes:
  MDS1   MDS2   MDS3   MDS4   MDS5   MDS6   MDS7   MDS8 
308206 157088  66759  37251  16494  10732   9839   7546 
(Showing 8 of 19 unconstrained eigenvalues)</code></pre>
<pre class="r"><code>anova(cap.tys, by=&quot;term&quot;)</code></pre>
<pre><code>Permutation test for capscale under reduced model
Terms added sequentially (first to last)
Permutation: free
Number of permutations: 999

Model: capscale(formula = sqrt(quant) ~ time + year + site + year:site + time:site, data = meta)
           Df Variance      F Pr(&gt;F)    
time        1   365958 515.98  0.001 ***
year        6    90609  21.29  0.001 ***
site        2     9512   6.71  0.001 ***
year:site  11    20086   2.57  0.001 ***
time:site   2     4417   3.11  0.018 *  
Residual  904   641159                  
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<pre class="r"><code>cap.tys.df &lt;- fortify(cap.tys) %&gt;% left_join(mutate(meta, score=&quot;sites&quot;), by=c(label=&quot;sample&quot;, &quot;score&quot;))

ggplot(filter(cap.tys.df, score==&quot;sites&quot;), aes(x=CAP1, y=CAP2, label=label)) +
  theme_classic() + theme(legend.position = &quot;top&quot;) + 
  geom_point(aes(color=year, shape=time)) +
  geom_text(data=filter(cap.tys.df, score==&quot;species&quot;)) +
  scale_color_manual(&quot;Year&quot;, values=pal$year) + 
  scale_shape_manual(&quot;Time&quot;, values=c(D=1,N=19))</code></pre>
<p><img src="images/cap_tys-1.svg" width="768" /></p>
</div>
<div id="cap-with-time-year-site-soil-moisture" class="section level2">
<h2>CAP with time, year, site, soil moisture</h2>
<pre class="r"><code>meta.withvwc &lt;- meta %&gt;% drop_na(VWC) %&gt;% 
  group_by(date, site, time) %&gt;% #see plot above for which dates have soil moisture data
  mutate(relVWC = VWC - mean(VWC)) %&gt;% ungroup() #VWC centered to mean for each sampling date
quant.withvwc &lt;- quant[meta.withvwc$sample,]

cap.tysv &lt;- capscale(sqrt(quant.withvwc) ~ time + year + site + relVWC, data=meta.withvwc)
cap.tysv</code></pre>
<pre><code>Call: capscale(formula = sqrt(quant.withvwc) ~ time + year + site + relVWC,
data = meta.withvwc)

-- Model Summary --

               Inertia Proportion Rank
Total         1.03e+06   1.00e+00     
Constrained   4.18e+05   4.07e-01    9
Unconstrained 6.10e+05   5.93e-01   19

Inertia is mean squared Euclidean distance

-- Note --

Species scores projected from &#39;sqrt&#39;
Species scores projected from &#39;quant.withvwc&#39;

-- Eigenvalues --

Eigenvalues for constrained axes:
  CAP1   CAP2   CAP3   CAP4   CAP5   CAP6   CAP7   CAP8   CAP9 
322833  77149   6947   5683   2663   1069    735    445     81 

Eigenvalues for unconstrained axes:
  MDS1   MDS2   MDS3   MDS4   MDS5   MDS6   MDS7   MDS8 
251397 177987  65455  49635  14311  11800   8224   7838 
(Showing 8 of 19 unconstrained eigenvalues)</code></pre>
<pre class="r"><code>anova(cap.tysv, by=&quot;term&quot;)</code></pre>
<pre><code>Permutation test for capscale under reduced model
Terms added sequentially (first to last)
Permutation: free
Number of permutations: 999

Model: capscale(formula = sqrt(quant.withvwc) ~ time + year + site + relVWC, data = meta.withvwc)
          Df Variance      F Pr(&gt;F)    
time       1   286720 240.78  0.001 ***
year       5   112705  18.93  0.001 ***
site       2    15733   6.61  0.001 ***
relVWC     1     2448   2.06  0.087 .  
Residual 512   609696                  
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
</div>
<div id="cap-with-year-within-time" class="section level2">
<h2>CAP with year, within time</h2>
<pre class="r"><code>meta.D &lt;- filter(meta, time==&quot;D&quot;)
quant.D &lt;- quant[rownames(meta.D),]
meta.N &lt;- filter(meta, time==&quot;N&quot;)
quant.N &lt;- quant[rownames(meta.N),]

cap.year.D.df &lt;- capscale(sqrt(quant.D) ~ year, data=meta.D) %&gt;% 
  fortify() %&gt;% left_join(mutate(meta, score=&quot;sites&quot;), by=c(label=&quot;sample&quot;, &quot;score&quot;))
ggplot(filter(cap.year.D.df, score==&quot;sites&quot;), aes(x=CAP1, y=CAP2, label=label)) +
  theme_classic() + theme(legend.position = &quot;top&quot;) + 
  geom_point(aes(color=year, shape=time)) +
  geom_text(data=filter(cap.year.D.df, score==&quot;species&quot;)) +
  scale_color_manual(&quot;Year&quot;, values=pal$year) + 
  scale_shape_manual(&quot;Time&quot;, values=c(D=1,N=19))</code></pre>
<p><img src="images/cap_year-1.svg" width="768" /></p>
<pre class="r"><code>cap.year.N.df &lt;- capscale(sqrt(quant.N) ~ year, data=meta.N) %&gt;% 
  fortify() %&gt;% left_join(mutate(meta, score=&quot;sites&quot;), by=c(label=&quot;sample&quot;, &quot;score&quot;))
ggplot(filter(cap.year.N.df, score==&quot;sites&quot;), aes(x=CAP1, y=CAP2, label=label)) +
  theme_classic() + theme(legend.position = &quot;top&quot;) + 
  geom_point(aes(color=year, shape=time)) +
  geom_text(data=filter(cap.year.N.df, score==&quot;species&quot;)) +
  scale_color_manual(&quot;Year&quot;, values=pal$year) + 
  scale_shape_manual(&quot;Time&quot;, values=c(D=1,N=19))</code></pre>
<p><img src="images/cap_year-2.svg" width="768" /></p>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
